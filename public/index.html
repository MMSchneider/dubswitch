<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DubSwitch â€” Modern Theme</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
  <!-- Local vendor fallback so packaged app doesn't rely on CDN -->
  <link rel="stylesheet" href="vendor/bootstrap.min.css">
  <!-- Local fallback for button basics when CDN cannot be loaded (packaged/offline) -->
  <style>
    /* Minimal button fallbacks that mirror essential Bootstrap look so
       controls remain visible inside a packaged app without network. */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.375rem .75rem;border-radius:.25rem;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;cursor:pointer}
    .btn:hover{opacity:0.95}
    .btn-square{padding-left:.8rem;padding-right:.8rem}
    .btn-icon-only{width:40px;height:40px;padding:0;min-width:40px;border-radius:.5rem;display:inline-flex;align-items:center;justify-content:center}
    .btn-danger{background:#c53030;color:#fff}
    .btn-success{background:#2f855a;color:#fff}
    .btn-outline-light{border:1px solid rgba(255,255,255,0.18);color:#e6eef3;background:transparent}
    .btn-sm{padding:.25rem .5rem;height:36px}
  </style>
  <style>
    /* Quick block buttons styling used in Settings -> Routing */
    .block-quick-buttons{display:flex;flex-direction:column;gap:8px;margin-left:6px;align-items:stretch;min-width:140px}
    .block-quick-btn{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;height:36px;border-radius:6px}
    .block-quick-btn .btn-label{flex:0 0 auto}
    .block-quick-btn .btn-badge{margin-left:8px}
  </style>
  <style>
    /* Matrix tweaks: make channel numbers more visible and set a scrollable max height */
    .matrix-ch-number{color:#ff9f1c;font-weight:700;padding-right:8px}
    /* Keep the matrix table limited in height so it doesn't overflow the app window; allow internal scrolling */
    .matrix-table-wrap{max-height:44vh;overflow:auto}
    /* Make table headers sticky inside the scrollable wrapper */
    .matrix-table-wrap table thead th{position:sticky;top:0;background:rgba(11,18,32,0.95);backdrop-filter:blur(4px);z-index:5}
    /* Improve table row spacing for readability on small heights */
    .matrix-table-wrap table.table-sm td, .matrix-table-wrap table.table-sm th{padding:6px 8px}
  </style>
  <style>
    :root{--bg:#071722;--panel:#0e1a24;--muted:#9aa6b2;--accent:#2dd4bf;--accent2:#60a5fa;--card:#0b1220;--radius:12px}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#04101a 0,#071722 100%);color:#e6eef3}
    .container-app{max-width:1200px;margin:20px auto;padding:12px}
    .site-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,0.6)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:40px;border-radius:6px}
    .brand h1{margin:0;font-size:1.05rem}
    .header-actions{display:flex;align-items:center;gap:12px}
    .header-version{color:var(--muted)}
    /* Use a flexible main column and fixed-aside; aside only shows on wider viewports to avoid squeezing main content */
    .layout{display:grid;grid-template-columns:minmax(0,1fr) 320px;gap:18px;margin-top:18px}
    /* Keep the main column full-width until the viewport is comfortably wide; hide aside until larger screens to avoid sudden shrink */
    @media (max-width:1400px){
      .layout{grid-template-columns:1fr}
      .layout main{grid-column:1/-1}
      .layout aside{display:none}
    }
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,0.6)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
  /* Let buttons flex smoothly and clamp sizes to avoid snapping */
  .controls .btn{flex:1 1 auto;min-width:72px;max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all 140ms ease}
    /* User-patch grid: fixed 8 columns x 4 rows layout (32 items). Keep consistent grid even when viewport resizes.
       If viewport is narrower than the grid width, allow horizontal scrolling instead of reflowing columns. */
  #userpatch-container{display:grid;grid-template-columns:repeat(8,1fr);grid-auto-rows:140px;gap:14px;min-width:1024px}
    /* Allow the parent card to scroll horizontally when viewport is narrow to preserve 8x4 layout */
    .card > #userpatch-container{overflow-x:auto;padding-bottom:6px}
    .card{width:100%;box-sizing:border-box;transition:all 140ms ease}
    .channel-card{background:rgba(255,255,255,0.02);border-radius:8px;padding:6px}
  /* Button polish: consistent, square-like controls and stable icon alignment */
  .controls .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:0 .75rem;height:44px;min-width:88px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.18);transition:transform .12s ease,box-shadow .12s ease}
  .controls .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.22)}
  /* Icon sizing inside buttons to avoid jumps */
  .controls .btn i,.controls .btn svg,.controls .btn img{width:18px;height:18px;flex:0 0 18px;display:inline-block}
  .controls .btn .btn-label{display:inline-block;max-width:9ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  /* Small variant retains square height */
  .controls .btn.btn-sm{height:40px;min-width:72px;padding:0 .6rem}
  /* Icon-only (square) buttons */
  .btn-icon-only{padding:0;width:40px;height:40px;min-width:40px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center}
  /* Ensure channel cards have stable internal layout so the edit icon doesn't jump */
  .channel-card{display:flex;flex-direction:column;align-items:flex-start;justify-content:space-between;min-height:72px;padding:12px;position:relative;overflow:visible}
  .channel-card .channel-top{display:flex;align-items:center;justify-content:space-between;width:100%}
  .channel-card .channel-title{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  /* Make the rename icon subtle and overlay it with transparent background */
  .channel-card .btn-icon-only{background:transparent;border:1px solid rgba(255,255,255,0.06);color:rgba(255,255,255,0.7);box-shadow:none}
  .channel-card .btn-icon-only:hover{background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.95)}
  /* Slightly pull the icon inwards so it's not so exposed */
  .channel-card .btn-icon-only{transform:translateY(-4px);} 
  .channel-card .btn-icon-only:focus{outline:2px solid rgba(96,165,250,0.35);outline-offset:2px}
  /* Ensure inner content doesn't overflow the card when blue (DAW) color is set */
  .channel-card .channel-btn{width:100%;height:100%;box-sizing:border-box;display:flex;flex-direction:column;justify-content:flex-end;padding:12px 10px 14px}
  .channel-card .channel-title{font-size:0.95rem;line-height:1.05}
  .channel-card .up-type{font-size:0.78rem}
    .small-muted{color:var(--muted);font-size:0.9rem}
    #clp-log{background:rgba(0,0,0,0.15);padding:8px;border-radius:6px;color:#bfe7df;max-height:180px;overflow:auto;font-family:monospace}
    #routing-table{width:100%;border-collapse:collapse}
    #routing-table td,#routing-table th{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .badge{padding:.45em .6em;border-radius:999px}
  /* collapse-panel and chevron not used when tabs are present */
    footer.footer{margin-top:18px;color:var(--muted);text-align:center}
  </style>
  <style>
    /* Toast container and toasts used by app.js showToast */
    #toast-container{position:fixed;right:16px;bottom:16px;z-index:20000}
    .dubswitch-toast{background:rgba(0,0,0,0.8);color:#e6eef3;padding:10px 14px;margin-top:8px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.5);opacity:0;transition:opacity 180ms ease,transform 220ms ease;transform:translateY(6px)}
    .dubswitch-toast.show{opacity:1;transform:translateY(0)}
    /* small spinner for toggle button (if used) */
    .btn-spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite;margin-left:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Improve contrast for small selects inside the Matrix table */
    #matrix-table-container select.form-control.form-control-sm{background:#0b1220;color:#e6eef3;border-color:rgba(255,255,255,0.06)}
  /* Make the matrix table header more readable against dark backgrounds */
  #matrix-table-container table thead th{color:#e6eef3;background:rgba(255,255,255,0.02);padding:8px 12px}
    /* Diagnostics pre-wrap so long lines don't overflow the modal */
    #diagnostics-status, #diagnostics-matrix-file { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <div class="container-app">
    <!-- Settings Modal (required by app.js) -->
    <div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
            <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Tabs for IP / OSC / Routing -->
            <ul class="nav nav-tabs" role="tablist">
              <li class="nav-item"><a class="nav-link active" id="tab-ip-link" data-toggle="tab" href="#tab-ip" role="tab" aria-controls="tab-ip" aria-selected="true">IP</a></li>
              <li class="nav-item"><a class="nav-link" id="tab-clp-link" data-toggle="tab" href="#tab-clp" role="tab" aria-controls="tab-clp" aria-selected="false">OSC</a></li>
              <li class="nav-item"><a class="nav-link" id="tab-routing-link" data-toggle="tab" href="#tab-routing" role="tab" aria-controls="tab-routing" aria-selected="false">Routing</a></li>
              <li class="nav-item"><a class="nav-link" id="tab-matrix-link" data-toggle="tab" href="#tab-matrix" role="tab" aria-controls="tab-matrix" aria-selected="false">Matrix</a></li>
              <li class="nav-item"><a class="nav-link" id="tab-server-link" data-toggle="tab" href="#tab-server" role="tab" aria-controls="tab-server" aria-selected="false">Server</a></li>
            </ul>
            <div class="tab-content" style="margin-top:12px">
              <div class="tab-pane fade show active" id="tab-ip" role="tabpanel" aria-labelledby="tab-ip-link">
                <div class="form-group">
                  <label for="x32IpInput">X32 IP Address</label>
                  <input type="text" class="form-control" id="x32IpInput" placeholder="e.g. 192.168.1.100">
                  <small class="form-text text-muted">Set manually if autodiscovery fails.</small>
                </div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                  <button type="button" class="btn btn-info" id="autodiscoverBtn">Autodetect</button>
                  <div style="flex:1"></div>
                  <button type="button" class="btn btn-secondary" id="enumerateBtn">Enumerate Sources</button>
                  <button type="button" class="btn btn-primary" id="saveIpBtn">Save</button>
                </div>
                <div id="enumerate-results-container" style="margin-top:10px;display:none">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                    <strong class="small-muted">Enumerate Results</strong>
                    <button id="enumerate-download-csv" class="btn btn-sm btn-outline-light" style="margin-left:8px">Download CSV</button>
                    <button id="enumerate-clear" class="btn btn-sm btn-outline-secondary" style="margin-left:6px">Clear</button>
                  </div>
                  <pre id="enumerate-results" style="max-height:220px;overflow:auto;background:#071722;padding:8px;border-radius:6px;color:#cfeee8"></pre>
                </div>
              </div>
              <div class="tab-pane fade" id="tab-clp" role="tabpanel" aria-labelledby="tab-clp-link">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                  <div style="display:flex;align-items:center;gap:8px">
                    <!-- chevron removed; tabs control visibility -->
                    <h5 style="margin:0">OSC Command Panel</h5>
                  </div>
                  <div class="small-muted">Send raw OSC to the X32</div>
                </div>
                <div id="clp-content">
                  <div id="clp">
                    <form onsubmit="event.preventDefault(); sendCustomOSC();" style="display:flex;gap:8px;flex-wrap:wrap">
                      <input id="clp-address" type="text" value="/xinfo" placeholder="OSC Address" style="flex:1;padding:8px;border-radius:6px;background:#071822;border:1px solid rgba(255,255,255,0.03);color:#e6eef3">
                      <input id="clp-args" type="text" placeholder='Args, e.g. 7, 3.14, "foo"' style="flex:1;padding:8px;border-radius:6px;background:#071822;border:1px solid rgba(255,255,255,0.03);color:#e6eef3">
                      <button class="btn btn-primary" type="submit">Send</button>
                    </form>
                    <div id="clp-log"></div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="tab-routing" role="tabpanel" aria-labelledby="tab-routing-link">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                    <div style="display:flex;align-items:center;gap:8px">
                      <!-- chevron removed; tabs control visibility -->
                      <h5 style="margin:0">Input Routing</h5>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                      <!-- Quick helper to set all blocks to UserIns -->
                      <button id="switch-to-userins" class="btn btn-sm btn-primary" title="Set all blocks to UserIns">Set all to UserIns</button>
                      <button id="toggle-inputs" class="btn btn-sm btn-outline-secondary" onclick="toggleAllInputs()" disabled>Switch all Inputs</button>
                      <!-- Per-block quick UserIns buttons (1-8, 9-16, 17-24, 25-32) -->
                      <div class="block-quick-buttons">
                        <button id="userins-block-0" class="btn btn-sm btn-outline-light block-quick-btn" title="Block 1-8 â€” click to toggle" onclick="setBlockToUserIns(0)"><span class="btn-label">1â€“8</span><span class="btn-badge"></span></button>
                        <button id="userins-block-1" class="btn btn-sm btn-outline-light block-quick-btn" title="Block 9-16 â€” click to toggle" onclick="setBlockToUserIns(1)"><span class="btn-label">9â€“16</span><span class="btn-badge"></span></button>
                        <button id="userins-block-2" class="btn btn-sm btn-outline-light block-quick-btn" title="Block 17-24 â€” click to toggle" onclick="setBlockToUserIns(2)"><span class="btn-label">17â€“24</span><span class="btn-badge"></span></button>
                        <button id="userins-block-3" class="btn btn-sm btn-outline-light block-quick-btn" title="Block 25-32 â€” click to toggle" onclick="setBlockToUserIns(3)"><span class="btn-label">25â€“32</span><span class="btn-badge"></span></button>
                      </div>
                    </div>
                  </div>
                <div id="routing-content">
                  <div class="small-muted" style="margin-bottom:10px">Make sure inputs are set to <strong>User Inputs</strong> on the console.</div>
                  <!-- Warning shown when all blocks are LocalIns; populated by app.js -->
                  <div id="userin-warning" style="display:none;margin-bottom:8px;color:#fff;background:#33110b;padding:10px;border-radius:6px;">All inputs are LocalIns â€” switch at least one block to UserIns to use the app.</div>
                  <!-- Short hint explaining the removed duplicate table -->
                  <div id="routing-hint" class="small-muted" style="margin-bottom:8px;color:#cfeee8;"></div>
                  <!-- The per-block table was removed because the top quick buttons
                       already provide the same functionality. The JS still updates
                       the button badges and global toggle. -->
                </div>
              </div>
              <div class="tab-pane fade" id="tab-matrix" role="tabpanel" aria-labelledby="tab-matrix-link">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                  <div style="display:flex;align-items:center;gap:8px">
                    <h5 style="margin:0">Toggle Matrix</h5>
                  </div>
                  <div class="small-muted">Define what toggle buttons do</div>
                </div>
                <div id="matrix-explainer" class="small-muted" style="margin-bottom:8px">Each block's toggle action and the global switch action can be set. Changes persist on the server.</div>
                <div id="matrix-table-container"></div>
                <div style="margin-top:10px"></div>
                <!-- Inline saved indicator (hidden by default). Shown when the server confirms matrix persistence -->
                <div id="matrix-saved-indicator" style="display:none;margin-top:6px;color:#9ee7c9;font-weight:600">Saved</div>
              </div>
              <div class="tab-pane fade" id="tab-server" role="tabpanel" aria-labelledby="tab-server-link">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                  <div style="display:flex;align-items:center;gap:8px">
                    <h5 style="margin:0">Local Server</h5>
                  </div>
                  <div class="small-muted">Configure the local HTTP server port</div>
                </div>
                <div class="form-group">
                  <label for="localPortInput">Local server port</label>
                  <input type="text" class="form-control" id="localPortInput" placeholder="e.g. 3000">
                  <small class="form-text text-muted">This sets the local HTTP server port for the app (default: 3000). Clicking Save will ask the running server to rebind to this port (POST /set-port). If the server cannot bind (port in use or permission denied) the request will fail â€” you can alternatively restart the server with <code>PORT=&lt;port&gt;</code> when launching.</small>
                </div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                  <div style="flex:1"></div>
                  <button type="button" class="btn btn-secondary" id="viewServerLogBtn">View server log</button>
                  <button type="button" class="btn btn-primary" id="savePortBtn">Save Port</button>
                  <button type="button" class="btn btn-sm btn-outline-light" id="restartNowBtn" style="margin-left:8px">Restart now</button>
                </div>
                <div id="serverStatusPreview" class="small-muted" style="margin-top:8px;font-family:monospace">Origin: â€” | status: â€”</div>
                <div id="serverLastStatus" class="small-muted" style="margin-top:6px;font-family:monospace">Last start: â€”</div>
              </div>
            </div>
            <!-- Hidden placeholders for legacy IDs expected by app.js/check scripts -->
            <span id="clp-chevron" style="display:none" aria-hidden="true"></span>
            <span id="routing-chevron" style="display:none" aria-hidden="true"></span>
          </div>
          <div class="modal-footer">
            <div style="flex:1"></div>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <header class="site-header">
      <div class="brand">
        <img id="brand-logo" alt="logo" style="display:none;" />
        <script>
          (function(){
            try {
              var img = document.getElementById('brand-logo');
              // If served over http(s), use the relative resources path (no extra probing)
              if (location.protocol === 'http:' || location.protocol === 'https:') {
                img.onload = function(){ img.style.display = 'inline-block'; };
                img.onerror = function(){ replaceWithFallback(); };
                img.src = 'resources/dubswitch_128.png';
                return;
              }

              // Running under file:// (packaged). Derive the most likely path once and try it.
              var p = location.pathname || '';
              // Normalize (remove trailing filename if present)
              var dir = p.replace(/\/[^/]*$/, '');
              // Look for the .app bundle layout and construct a canonical path
              var candidate = null;
              var idx = dir.indexOf('/Contents/Resources');
              if (idx !== -1) {
                // Common Electron layout: /.../MyApp.app/Contents/Resources/app/... or /Contents/Resources/app
                candidate = dir.substring(0, idx + '/Contents/Resources'.length) + '/app/resources/dubswitch_128.png';
              } else {
                // Fallback: try relative resources next to the running HTML
                candidate = dir + '/resources/dubswitch_128.png';
              }

              // Only attempt a single src assignment to avoid multiple failed network logs in DevTools
              img.onload = function(){ img.style.display = 'inline-block'; };
              img.onerror = function(){ replaceWithFallback(); };
              img.src = candidate;

              function replaceWithFallback(){
                try{
                  var svg = document.createElement('div');
                  svg.innerHTML = '<svg viewBox="0 0 48 48" width="40" height="40" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="DubSwitch">' +
                    '<rect width="48" height="48" rx="8" fill="#0b1220"/>' +
                    '<g fill="#2dd4bf">' +
                      '<circle cx="15" cy="24" r="6"/>' +
                      '<rect x="24" y="14" width="12" height="20" rx="3"/>' +
                    '</g>' +
                    '</svg>';
                  img.parentNode.replaceChild(svg, img);
                }catch(e){ try{ img.style.display='none' }catch(e){} }
              }
            } catch (e) {
              try{ document.getElementById('brand-logo').style.display='none' }catch(e){}
            }
          })();
        </script>
        <h1>DubSwitch â€” X32 Router</h1>
      </div>
      <div class="header-actions">
  <div class="header-version" id="header-version">&nbsp;</div>
  <div id="status" class="small-muted">Local: â€”</div>
        <div id="x32-ip-indicator" class="small-muted" style="margin-left:6px;min-width:120px;text-align:right">X32: â€”</div>
        <button id="diagnosticsBtn" class="btn btn-outline-light btn-sm" title="Diagnostics">Diagnostics</button>
        <button id="settingsBtn" class="btn btn-warning btn-sm">Settings</button>
      </div>
    </header>

    <div class="layout">
      <main>

        <!-- (Status moved below the DubSwitches card) -->

        <section class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <h2 style="margin:0">DubSwitches</h2>
            <div class="controls">
              <!-- Refresh: icon-only compact button -->
              <button class="btn btn-icon-only btn-outline-light" aria-label="Refresh" title="Refresh" onclick="refreshUserPatches()">
                <!-- refresh SVG -->
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0114.13-3.36L23 10"></path><path d="M20.49 15a9 9 0 01-14.13 3.36L1 14"></path></svg>
              </button>
              <button class="btn btn-square btn-danger" onclick="setAllUserPatchesLocal()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"></path><path d="M3 6h18"></path></svg>
                <span class="btn-label">Local</span>
              </button>
              <button class="btn btn-square btn-success" onclick="setAllUserPatchesCard()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"></rect><path d="M8 21h8"></path></svg>
                <span class="btn-label">Card</span>
              </button>
            </div>
          </div>
          <div id="userpatch-container"></div>
        </section>

        <!-- Status card removed (toasts preferred). Warnings are surfaced via toasts. -->

        <!-- OSC Command Panel and Input Routing moved into Settings modal -->

        <footer class="footer">
          <div class="small-muted" style="margin-top:8px">
            <span id="app-version" aria-label="App version"></span>Made &amp; built by Mike Schneider â€” <a href="https://dubmajor.de" target="_blank" style="color:inherit;text-decoration:underline">dubmajor.de</a>
          </div>
        </footer>
      </main>

      <aside>
        <!-- aside now only contains other controls or space for future widgets -->
      </aside>
    </div>
  </div>

  <!-- Diagnostics Modal -->
  <div class="modal fade" id="diagnosticsModal" tabindex="-1" role="dialog" aria-labelledby="diagnosticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="diagnosticsModalLabel">Diagnostics</h5>
          <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <button id="diagnostics-refresh" class="btn btn-sm btn-primary">Refresh</button>
            <button id="diagnostics-copy-status" class="btn btn-sm btn-outline-light">Copy Status</button>
            <button id="diagnostics-copy-matrix" class="btn btn-sm btn-outline-light">Copy Matrix Info</button>
            <div style="flex:1"></div>
            <div class="small-muted">Shows server /status and matrix-file diagnostics</div>
            <div id="diagnostics-spinner" style="margin-left:8px;display:none"><span class="btn-spinner" aria-hidden="true"></span></div>
          </div>
          <div style="display:flex;gap:12px">
            <div style="flex:1">
              <h6 style="margin-top:0">/status</h6>
              <pre id="diagnostics-status" style="background:#071722;padding:8px;border-radius:6px;color:#cfeee8;max-height:320px;overflow:auto">Loadingâ€¦</pre>
            </div>
            <div style="flex:1">
              <h6 style="margin-top:0">/troubleshoot/matrix-file</h6>
              <pre id="diagnostics-matrix-file" style="background:#071722;padding:8px;border-radius:6px;color:#cfeee8;max-height:320px;overflow:auto">Loadingâ€¦</pre>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div style="flex:1"></div>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Apply Confirmation Modal -->
  <div class="modal fade" id="bulkApplyConfirmModal" tabindex="-1" role="dialog" aria-labelledby="bulkApplyConfirmLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="bulkApplyConfirmLabel">Confirm bulk change</h5>
          <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <p id="bulkApplyConfirmText">Are you sure?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" id="bulkApplyConfirmOk" class="btn btn-primary">Yes, apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- scripts -->
  <!-- Load jQuery/Bootstrap from CDN when available; otherwise use local vendor fallbacks so packaged app works offline -->
  <script>
    (function(){
      function insertScript(src, onload, onerror){
        var s = document.createElement('script'); s.src = src; s.defer = true;
        try { if (window.__DUBSWITCH_DEBUG__ || location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') { console.log('[DubSwitch] inserting <script> =>', src); } } catch (e) {}
        if (onload) s.onload = onload; if (onerror) s.onerror = onerror; document.head.appendChild(s);
        return s;
      }

      var jqueryCdn = 'https://code.jquery.com/jquery-3.5.1.min.js';
      var localJq = 'vendor/jquery-3.5.1.min.js';
      var bootstrapCdn = 'https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js';
      var localBootstrapBundle = 'vendor/bootstrap.bundle.min.js';

      // Helper to load the app script after vendors are ready
      function loadApp(){
        // Insert the main app script (deferred) so it runs after vendor scripts
        try { if (window.__DUBSWITCH_DEBUG__ || location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') { console.log('[DubSwitch] loading app.js'); } } catch (e) {}
        insertScript('app.js', function(){ try { console.log('[DubSwitch] app.js loaded'); } catch (e) {} }, function(){ try { console.warn('[DubSwitch] app.js failed to load'); } catch (e) {} });
      }

      // Load bootstrap (prefer CDN) â€” called only after jQuery is available or attempted
      function loadBootstrapBundle(){
        insertScript(bootstrapCdn, function(){ try { console.log('[DubSwitch] bootstrap.bundle CDN loaded'); } catch (e) {} ; loadApp(); }, function(){ try { console.warn('[DubSwitch] bootstrap.bundle CDN failed, falling back to local'); } catch (e) {} ; insertScript(localBootstrapBundle, function(){ try { console.log('[DubSwitch] local bootstrap.bundle loaded'); } catch (e) {} ; loadApp(); }, function(){ try { console.warn('[DubSwitch] local bootstrap.bundle failed to load'); } catch (e) {} ; loadApp(); }); });
      }

      try {
        if (location.protocol === 'file:'){
          // Packaged/offline: load local vendor files in sequence, then the app
          insertScript(localJq, function(){ try { console.log('[DubSwitch] local jQuery loaded'); } catch (e) {} ; insertScript(localBootstrapBundle, function(){ try { console.log('[DubSwitch] local bootstrap.bundle loaded'); } catch (e) {} ; loadApp(); }, function(){ try { console.warn('[DubSwitch] local bootstrap.bundle failed'); } catch (e) {} ; loadApp(); }); }, function(){ try { console.warn('[DubSwitch] Local jQuery failed to load'); } catch (e) {} ; insertScript(localBootstrapBundle, function(){ try { console.log('[DubSwitch] local bootstrap.bundle loaded (no jQuery)'); } catch (e) {} ; loadApp(); }, function(){ try { console.warn('[DubSwitch] local bootstrap.bundle failed (no jQuery)'); } catch (e) {} ; loadApp(); }); });
        } else {
          // Web context: load jQuery first, then bootstrap. Fallback to local jQuery when CDN fails.
          insertScript(jqueryCdn, function(){
            // jQuery CDN loaded successfully
            try { console.log('[DubSwitch] jQuery CDN loaded'); } catch (e) {}
            loadBootstrapBundle();
          }, function(){
            // jQuery CDN failed; try local jQuery then load bootstrap
            try { console.warn('[DubSwitch] jQuery CDN failed, trying local'); } catch (e) {}
            insertScript(localJq, function(){ try { console.log('[DubSwitch] local jQuery loaded'); } catch (e) {} ; loadBootstrapBundle(); }, function(){ try { console.warn('[DubSwitch] Local jQuery failed to load'); } catch (e) {} ; loadBootstrapBundle(); });
          });
        }
      } catch (e) { console.warn('vendor loader failed', e); }
    })();
  </script>
  <!-- Load dev-only shims when on localhost or when window.__DUBSWITCH_DEV_SHIMS__ === true -->
  <script>
    (function(){
      try {
        const host = location.hostname;
        if (host === 'localhost' || host === '127.0.0.1' || window.__DUBSWITCH_DEV_SHIMS__ === true) {
          const s = document.createElement('script');
          s.src = 'dev-shims.js';
          s.defer = true;
          document.head.appendChild(s);
        }
        // Small debug banner removed per request (was showing Origin | WS)
        try {
          // intentionally no-op: banner disabled
        } catch (e) {}
      } catch (e) {}
    })();
  </script>
  <!-- app.js is loaded dynamically after vendor scripts to ensure jQuery/bootstrap are available -->
  <!-- Server log modal -->
  <div class="modal fade" id="serverLogModal" tabindex="-1" role="dialog" aria-labelledby="serverLogModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="serverLogModalLabel">Server Log</h5>
          <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <button id="logRefreshBtn" class="btn btn-sm btn-outline-light">Refresh</button>
            <button id="logLoadOlderBtn" class="btn btn-sm btn-outline-light">Load older</button>
            <div style="flex:1"></div>
            <div id="logSizeLabel" class="small-muted">Size: â€”</div>
          </div>
          <pre id="serverLogContent" style="background:#071722;padding:8px;border-radius:6px;color:#cfeee8;max-height:60vh;overflow:auto;white-space:pre-wrap;word-break:break-word">Loadingâ€¦</pre>
        </div>
        <div class="modal-footer"><div style="flex:1"></div><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button></div>
      </div>
    </div>
  </div>
</body>
</html>
