<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DubSwitch â€” Modern Theme</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
  <style>
    :root{--bg:#071722;--panel:#0e1a24;--muted:#9aa6b2;--accent:#2dd4bf;--accent2:#60a5fa;--card:#0b1220;--radius:12px}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#04101a 0,#071722 100%);color:#e6eef3}
    .container-app{max-width:1200px;margin:20px auto;padding:12px}
    .site-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,0.6)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:40px;border-radius:6px}
    .brand h1{margin:0;font-size:1.05rem}
    .header-actions{display:flex;align-items:center;gap:12px}
    .header-version{color:var(--muted)}
    /* Use a flexible main column and fixed-aside; aside only shows on wider viewports to avoid squeezing main content */
    .layout{display:grid;grid-template-columns:minmax(0,1fr) 320px;gap:18px;margin-top:18px}
    /* Keep the main column full-width until the viewport is comfortably wide; hide aside until larger screens to avoid sudden shrink */
    @media (max-width:1400px){
      .layout{grid-template-columns:1fr}
      .layout main{grid-column:1/-1}
      .layout aside{display:none}
    }
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,0.6)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
  /* Let buttons flex smoothly and clamp sizes to avoid snapping */
  .controls .btn{flex:1 1 auto;min-width:72px;max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all 140ms ease}
    /* User-patch grid: fixed 8 columns x 4 rows layout (32 items). Keep consistent grid even when viewport resizes.
       If viewport is narrower than the grid width, allow horizontal scrolling instead of reflowing columns. */
  #userpatch-container{display:grid;grid-template-columns:repeat(8,1fr);grid-auto-rows:140px;gap:14px;min-width:1024px}
    /* Allow the parent card to scroll horizontally when viewport is narrow to preserve 8x4 layout */
    .card > #userpatch-container{overflow-x:auto;padding-bottom:6px}
    .card{width:100%;box-sizing:border-box;transition:all 140ms ease}
    .channel-card{background:rgba(255,255,255,0.02);border-radius:8px;padding:6px}
  /* Button polish: consistent, square-like controls and stable icon alignment */
  .controls .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:0 .75rem;height:44px;min-width:88px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.18);transition:transform .12s ease,box-shadow .12s ease}
  .controls .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.22)}
  /* Icon sizing inside buttons to avoid jumps */
  .controls .btn i,.controls .btn svg,.controls .btn img{width:18px;height:18px;flex:0 0 18px;display:inline-block}
  .controls .btn .btn-label{display:inline-block;max-width:9ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  /* Small variant retains square height */
  .controls .btn.btn-sm{height:40px;min-width:72px;padding:0 .6rem}
  /* Icon-only (square) buttons */
  .btn-icon-only{padding:0;width:40px;height:40px;min-width:40px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center}
  /* Ensure channel cards have stable internal layout so the edit icon doesn't jump */
  .channel-card{display:flex;flex-direction:column;align-items:flex-start;justify-content:space-between;min-height:72px;padding:12px;position:relative;overflow:visible}
  .channel-card .channel-top{display:flex;align-items:center;justify-content:space-between;width:100%}
  .channel-card .channel-title{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  /* Make the rename icon subtle and overlay it with transparent background */
  .channel-card .btn-icon-only{background:transparent;border:1px solid rgba(255,255,255,0.06);color:rgba(255,255,255,0.7);box-shadow:none}
  .channel-card .btn-icon-only:hover{background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.95)}
  /* Slightly pull the icon inwards so it's not so exposed */
  .channel-card .btn-icon-only{transform:translateY(-4px);}
  .channel-card .btn-icon-only:focus{outline:2px solid rgba(96,165,250,0.35);outline-offset:2px}
  /* Ensure inner content doesn't overflow the card when blue (DAW) color is set */
  .channel-card .channel-btn{width:100%;height:100%;box-sizing:border-box;display:flex;flex-direction:column;justify-content:flex-end;padding:12px 10px 14px}
  .channel-card .channel-title{font-size:0.95rem;line-height:1.05}
  .channel-card .up-type{font-size:0.78rem}
    .small-muted{color:var(--muted);font-size:0.9rem}
    #clp-log{background:rgba(0,0,0,0.15);padding:8px;border-radius:6px;color:#bfe7df;max-height:180px;overflow:auto;font-family:monospace}
    #routing-table{width:100%;border-collapse:collapse}
    #routing-table td,#routing-table th{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .badge{padding:.45em .6em;border-radius:999px}
  /* collapse-panel and chevron not used when tabs are present */
    footer.footer{margin-top:18px;color:var(--muted);text-align:center}
  </style>
  <style>
    /* Toast container and toasts used by app.js showToast */
    #toast-container{position:fixed;right:16px;bottom:16px;z-index:20000}
    .dubswitch-toast{background:rgba(0,0,0,0.8);color:#e6eef3;padding:10px 14px;margin-top:8px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.5);opacity:0;transition:opacity 180ms ease,transform 220ms ease;transform:translateY(6px)}
    .dubswitch-toast.show{opacity:1;transform:translateY(0)}
    .btn-spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite;margin-left:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container-app">
    <!-- Settings Modal (required by app.js) -->
    <div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
            <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Tabs for IP / OSC / Routing -->
            <ul class="nav nav-tabs" role="tablist">
              <li class="nav-item"><a class="nav-link active" id="tab-ip-link" data-toggle="tab" href="#tab-ip" role="tab" aria-controls="tab-ip" aria-selected="true">IP</a></li>
              <li class="nav-item"><a class="nav-link" id="tab-clp-link" data-toggle="tab" href="#tab-clp" role="tab" aria-controls="tab-clp" aria-selected="false">OSC</a></li>
              <li class="nav-item"><a class="nav-link" id="tab-routing-link" data-toggle="tab" href="#tab-routing" role="tab" aria-controls="tab-routing" aria-selected="false">Routing</a></li>
              <li class="nav-item"><a class="nav-link" id="tab-matrix-link" data-toggle="tab" href="#tab-matrix" role="tab" aria-controls="tab-matrix" aria-selected="false">Matrix</a></li>
            </ul>
            <div class="tab-content" style="margin-top:12px">
              <div class="tab-pane fade show active" id="tab-ip" role="tabpanel" aria-labelledby="tab-ip-link">
                <div class="form-group">
                  <label for="x32IpInput">X32 IP Address</label>
                  <input type="text" class="form-control" id="x32IpInput" placeholder="e.g. 192.168.1.100">
                  <small class="form-text text-muted">Set manually if autodiscovery fails.</small>
                </div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                  <button type="button" class="btn btn-info" id="autodiscoverBtn">Autodetect</button>
                  <div style="flex:1"></div>
                  <button type="button" class="btn btn-secondary" id="enumerateBtn">Enumerate Sources</button>
                  <button type="button" class="btn btn-primary" id="saveIpBtn">Save</button>
                </div>
                <div id="enumerate-results-container" style="margin-top:10px;display:none">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                    <strong class="small-muted">Enumerate Results</strong>
                    <button id="enumerate-download-csv" class="btn btn-sm btn-outline-light" style="margin-left:8px">Download CSV</button>
                    <button id="enumerate-clear" class="btn btn-sm btn-outline-secondary" style="margin-left:6px">Clear</button>
                  </div>
                  <pre id="enumerate-results" style="max-height:220px;overflow:auto;background:#071722;padding:8px;border-radius:6px;color:#cfeee8"></pre>
                </div>
              </div>
              <div class="tab-pane fade" id="tab-clp" role="tabpanel" aria-labelledby="tab-clp-link">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                  <div style="display:flex;align-items:center;gap:8px">
                    <!-- chevron removed; tabs control visibility -->
                    <h5 style="margin:0">OSC Command Panel</h5>
                  </div>
                  <div class="small-muted">Send raw OSC to the X32</div>
                </div>
                <div id="clp-content">
                  <div id="clp">
                    <form onsubmit="event.preventDefault(); sendCustomOSC();" style="display:flex;gap:8px;flex-wrap:wrap">
                      <input id="clp-address" type="text" value="/xinfo" placeholder="OSC Address" style="flex:1;padding:8px;border-radius:6px;background:#071822;border:1px solid rgba(255,255,255,0.03);color:#e6eef3">
                      <input id="clp-args" type="text" placeholder='Args, e.g. 7, 3.14, "foo"' style="flex:1;padding:8px;border-radius:6px;background:#071822;border:1px solid rgba(255,255,255,0.03);color:#e6eef3">
                      <button class="btn btn-primary" type="submit">Send</button>
                    </form>
                    <div id="clp-log"></div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="tab-routing" role="tabpanel" aria-labelledby="tab-routing-link">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                  <div style="display:flex;align-items:center;gap:8px">
                    <!-- chevron removed; tabs control visibility -->
                    <h5 style="margin:0">Input Routing</h5>
                  </div>
                  <div><button id="toggle-inputs" class="btn btn-sm btn-outline-secondary" onclick="toggleAllInputs()" disabled>Switch all Inputs</button></div>
                </div>
                <div id="routing-content">
                  <div class="small-muted" style="margin-bottom:10px">Make sure inputs are set to <strong>User Inputs</strong> on the console.</div>
                  <table id="routing-table"></table>
                </div>
              </div>
              <div class="tab-pane fade" id="tab-matrix" role="tabpanel" aria-labelledby="tab-matrix-link">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                  <div style="display:flex;align-items:center;gap:8px">
                    <h5 style="margin:0">Toggle Matrix</h5>
                  </div>
                  <div class="small-muted">Define what toggle buttons do</div>
                </div>
                <!--
                  Matrix tab
                  - #matrix-table-container: where the JS will render the block-level
                    editor and the per-channel A/B table.
                  - #matrix-autosave: checkbox (when checked the client will
                    send a 'set_matrix' with an inferred matrix on startup).
                  - #matrix-allow-local-toggle: when set, the client will not
                    disable channel toggles when a block is currently using
                    LocalIns (useful for advanced workflows).
                -->
                <div id="matrix-explainer" class="small-muted" style="margin-bottom:8px">Each block's toggle action and the global switch action can be set. Changes persist on the server.</div>
                <div id="matrix-table-container"></div>
                <div style="display:flex;align-items:center;gap:16px;margin-top:10px">
                  <label class="small-muted" style="display:flex;align-items:center;gap:8px">
                    <input type="checkbox" id="matrix-autosave" style="margin-right:8px"> Auto-save inferred matrix on startup
                  </label>
                  <label class="small-muted" style="display:flex;align-items:center;gap:8px">
                    <input type="checkbox" id="matrix-allow-local-toggle" style="margin-right:8px"> Allow toggles when block is LocalIns
                  </label>
                </div>
              </div>
            </div>
            <!-- Hidden placeholders for legacy IDs expected by app.js/check scripts -->
            <span id="clp-chevron" style="display:none" aria-hidden="true"></span>
            <span id="routing-chevron" style="display:none" aria-hidden="true"></span>
          </div>
          <div class="modal-footer">
            <div style="flex:1"></div>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <header class="site-header">
      <div class="brand">
        <img src="resources/dubswitch_128.png" alt="logo" onerror="this.style.display='none'">
        <h1>DubSwitch â€” X32 Router</h1>
      </div>
      <div class="header-actions">
        <div class="header-version" id="header-version">&nbsp;</div>
        <div id="status" class="small-muted">Status: Connecting...</div>
        <button id="settingsBtn" class="btn btn-warning btn-sm">Settings</button>
      </div>
    </header>

    <div class="layout">
      <main>

        <!-- (Status moved below the DubSwitches card) -->

        <section class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <h2 style="margin:0">DubSwitches</h2>
            <div class="controls">
              <!-- Refresh: icon-only compact button -->
              <button class="btn btn-icon-only btn-outline-light" aria-label="Refresh" title="Refresh" onclick="refreshUserPatches()">
                <!-- refresh SVG -->
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0114.13-3.36L23 10"></path><path d="M20.49 15a9 9 0 01-14.13 3.36L1 14"></path></svg>
              </button>
              <button class="btn btn-square btn-danger" onclick="setAllUserPatchesLocal()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"></path><path d="M3 6h18"></path></svg>
                <span class="btn-label">Local</span>
              </button>
              <button class="btn btn-square btn-success" onclick="setAllUserPatchesCard()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"></rect><path d="M8 21h8"></path></svg>
                <span class="btn-label">Card</span>
              </button>
            </div>
          </div>
          <div id="userpatch-container"></div>
        </section>

        <!-- Warnings / Status (moved here to appear below DubSwitches) -->
        <section class="card" style="margin-top:12px">
          <h5>Status</h5>
          <div id="userin-warning" style="display:none;background:#2b0f10;color:#ffd7d7;padding:10px;border-radius:8px;margin-top:8px">
            <strong>Input Routing Error</strong>
            <p style="margin:8px 0 0">All inputs must be set to <b>User Inputs</b> for this app to operate correctly.</p>
            <button id="switch-to-userins" class="btn btn-sm btn-success" style="margin-top:8px">Switch All Inputs to UserIns</button>
          </div>
          <div id="connect-warning" style="display:none;background:#0e1720;color:#bfe7df;padding:10px;border-radius:8px;margin-top:8px">
            <strong>Waiting for X32 Connectionâ€¦</strong>
            <div style="margin-top:8px"><button id="manualIpBtn" class="btn btn-sm btn-warning">Enter IP Manually</button></div>
          </div>
        </section>

        <!-- OSC Command Panel and Input Routing moved into Settings modal -->

        <footer class="footer">
          <div class="small-muted" style="margin-top:8px">
            Made &amp; built by Mike Schneider â€” <a href="https://dubmajor.de" target="_blank" style="color:inherit;text-decoration:underline">dubmajor.de</a>
          </div>
        </footer>
      </main>

      <aside>
        <!-- aside now only contains other controls or space for future widgets -->
      </aside>
    </div>
  </div>

  <!-- scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Load dev-only shims when on localhost or when window.__DUBSWITCH_DEV_SHIMS__ === true -->
  <script>
    (function(){
      try {
        const host = location.hostname;
        if (host === 'localhost' || host === '127.0.0.1' || window.__DUBSWITCH_DEV_SHIMS__ === true) {
          const s = document.createElement('script');
          s.src = 'dev-shims.js';
          s.defer = true;
          document.head.appendChild(s);
        }
      } catch (e) {}
    })();
  </script>
  <script src="app.js"></script>
</body>
</html>